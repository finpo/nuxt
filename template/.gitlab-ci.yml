variables:
  APPNAME: ${CI_PROJECT_NAME}
  DEMO_URL: 'demo.finpo.com.tw'
  PRODUCTION_URL: 'alpaca.finpo.com.tw'

stages:
  - test
  # - preview
  # - production

cache:
  untracked: true
  key: "$CI_PROJECT_ID"
  paths:
    - node_modules/
    - .yarn

test:
  image: node:10-alpine
  stage: test
  script:
    - yarn install
    - yarn run lint
    - yarn run build

# preview:
#   image: docker:git
#   stage: preview
#   services:
#     - docker:dind
#   script:
#   - mkdir -p ~/.ssh
#   - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
#   - chmod 600 ~/.ssh/id_rsa
#   - ssh-keyscan -H ${DEMO_URL} >> ~/.ssh/known_hosts
#   - git config --global user.name "gitlab"
#   - git config --global user.email "gitlab@finpo.com.tw"
#   - 'echo -e "User-agent: *\nDisallow: /\n" > static/robots.txt'
#   - docker build -t dokku/${APPNAME}:latest . && docker save dokku/${APPNAME}:latest | ssh ausir@${DEMO_URL} "sudo docker load && dokku tags:deploy ${APPNAME} latest"
#   only:
#     - master


# production:
#   image: docker:git
#   stage: production
#   services:
#     - docker:dind
#   script:
#   - mkdir -p ~/.ssh
#   - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
#   - chmod 600 ~/.ssh/id_rsa
#   - ssh-keyscan -H ${PRODUCTION_URL} >> ~/.ssh/known_hosts
#   - docker build -t dokku/${APPNAME}:latest . && docker save dokku/${APPNAME}:latest | ssh ausir@${PRODUCTION_URL} "sudo docker load && dokku tags:deploy ${APPNAME} latest"
#   only:
#     - deploy

